// Full DTF Gang Sheet Editor with modern UI, layer management, undo/redo, templates, font/text support, export options

import React, { useRef, useState, useEffect } from 'react';
import { Stage, Layer, Rect, Image as KonvaImage, Text as KonvaText, Transformer } from 'react-konva';
import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
import html2canvas from 'html2canvas';
import jsPDF from 'jspdf';
import useImage from 'use-image';

const inchToPx = 96; // 1 inch = 96px

const defaultCanvas = {
  width: 12 * inchToPx,
  height: 18 * inchToPx,
};

const TemplateItem = ({ src, onAdd }) => (
  <img
    src={src}
    onClick={() => onAdd(src)}
    className="w-16 h-16 border m-1 cursor-pointer"
    alt="template"
  />
);

const LayerManager = ({ layers, selectedId, onSelect, onDelete }) => (
  <div className="p-2 border rounded-md bg-white w-full">
    <h3 className="font-bold mb-2">Layers</h3>
    {layers.map((layer, index) => (
      <div
        key={index}
        className={`flex justify-between items-center p-1 cursor-pointer ${selectedId === index ? 'bg-blue-100' : ''}`}
        onClick={() => onSelect(index)}
      >
        <span>{layer.type}</span>
        <Button size="sm" variant="ghost" onClick={(e) => { e.stopPropagation(); onDelete(index); }}>üóëÔ∏è</Button>
      </div>
    ))}
  </div>
);

const ImageItem = ({ src, x, y, onSelect, isSelected, onChange, rotation }) => {
  const [image] = useImage(src);
  const shapeRef = useRef();
  const trRef = useRef();

  useEffect(() => {
    if (isSelected) {
      trRef.current?.nodes([shapeRef.current]);
      trRef.current?.getLayer().batchDraw();
    }
  }, [isSelected]);

  return (
    <>
      <KonvaImage
        image={image}
        x={x}
        y={y}
        draggable
        rotation={rotation}
        onClick={onSelect}
        ref={shapeRef}
        onDragEnd={(e) => onChange({ x: e.target.x(), y: e.target.y() })}
        onTransformEnd={(e) => {
          const node = shapeRef.current;
          onChange({
            x: node.x(),
            y: node.y(),
            rotation: node.rotation(),
          });
        }}
      />
      {isSelected && <Transformer ref={trRef} rotateEnabled={true} />}
    </>
  );
};

const TextItem = ({ text, x, y, onSelect, isSelected, onChange }) => {
  const shapeRef = useRef();
  const trRef = useRef();

  useEffect(() => {
    if (isSelected) {
      trRef.current?.nodes([shapeRef.current]);
      trRef.current?.getLayer().batchDraw();
    }
  }, [isSelected]);

  return (
    <>
      <KonvaText
        text={text}
        x={x}
        y={y}
        fontSize={24}
        draggable
        ref={shapeRef}
        onClick={onSelect}
        onDragEnd={(e) => onChange({ x: e.target.x(), y: e.target.y() })}
      />
      {isSelected && <Transformer ref={trRef} />}
    </>
  );
};

export default function Editor() {
  const stageRef = useRef();
  const [elements, setElements] = useState([]);
  const [selectedId, setSelectedId] = useState(null);
  const [undoStack, setUndoStack] = useState([]);
  const [redoStack, setRedoStack] = useState([]);
  const [canvasSize, setCanvasSize] = useState(defaultCanvas);
  const [newText, setNewText] = useState('');

  const addImage = (src) => {
    const newElement = {
      type: 'image',
      src,
      x: 50,
      y: 50,
      rotation: 0,
    };
    setElements([...elements, newElement]);
    saveState();
  };

  const addText = () => {
    const newElement = {
      type: 'text',
      text: newText,
      x: 50,
      y: 50,
    };
    setElements([...elements, newElement]);
    setNewText('');
    saveState();
  };

  const updateElement = (index, changes) => {
    const updated = elements.map((el, i) => i === index ? { ...el, ...changes } : el);
    setElements(updated);
    saveState();
  };

  const deleteElement = (index) => {
    const updated = elements.filter((_, i) => i !== index);
    setElements(updated);
    setSelectedId(null);
    saveState();
  };

  const saveState = () => {
    setUndoStack([...undoStack, elements]);
    setRedoStack([]);
  };

  const undo = () => {
    if (undoStack.length === 0) return;
    const prev = undoStack.pop();
    setRedoStack([...redoStack, elements]);
    setElements(prev);
  };

  const redo = () => {
    if (redoStack.length === 0) return;
    const next = redoStack.pop();
    setUndoStack([...undoStack, elements]);
    setElements(next);
  };

  const exportAsPNG = async () => {
    const uri = stageRef.current.toDataURL();
    const link = document.createElement('a');
    link.download = 'canvas.png';
    link.href = uri;
    link.click();
  };

  const exportAsPDF = async () => {
    const canvas = await html2canvas(stageRef.current.container());
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF();
    pdf.addImage(imgData, 'PNG', 0, 0);
    pdf.save('canvas.pdf');
  };

  const autoArrange = () => {
    const spacing = 100;
    const arranged = elements.map((el, i) => ({ ...el, x: 10, y: i * spacing + 10 }));
    setElements(arranged);
  };

  return (
    <div className="flex flex-col md:flex-row gap-4 p-4">
      <div className="flex flex-col gap-2 w-full md:w-1/4">
        <Card className="p-2">
          <h2 className="font-bold">Controls</h2>
          <input
            type="text"
            placeholder="Text..."
            value={newText}
            onChange={(e) => setNewText(e.target.value)}
            className="border rounded p-1 mb-1 w-full"
          />
          <Button onClick={addText}>Add Text</Button>
          <Button onClick={undo}>Undo</Button>
          <Button onClick={redo}>Redo</Button>
          <Button onClick={exportAsPNG}>Export PNG</Button>
          <Button onClick={exportAsPDF}>Export PDF</Button>
          <Button onClick={autoArrange}>Auto Arrange</Button>
        </Card>

        <Card className="p-2">
          <h2 className="font-bold mb-2">Templates</h2>
          <div className="flex flex-wrap">
            <TemplateItem src="/cat.png" onAdd={addImage} />
            <TemplateItem src="/flower.png" onAdd={addImage} />
          </div>
        </Card>

        <LayerManager
          layers={elements}
          selectedId={selectedId}
          onSelect={setSelectedId}
          onDelete={deleteElement}
        />
      </div>

      <div className="flex-1 overflow-auto border">
        <Stage
          width={canvasSize.width}
          height={canvasSize.height}
          ref={stageRef}
          className="touch-none"
          style={{ background: '#f0f0f0' }}
        >
          <Layer>
            {elements.map((el, i) => {
              if (el.type === 'image') {
                return (
                  <ImageItem
                    key={i}
                    src={el.src}
                    x={el.x}
                    y={el.y}
                    rotation={el.rotation}
                    isSelected={selectedId === i}
                    onSelect={() => setSelectedId(i)}
                    onChange={(attrs) => updateElement(i, attrs)}
                  />
                );
              } else if (el.type === 'text') {
                return (
                  <TextItem
                    key={i}
                    text={el.text}
                    x={el.x}
                    y={el.y}
                    isSelected={selectedId === i}
                    onSelect={() => setSelectedId(i)}
                    onChange={(attrs) => updateElement(i, attrs)}
                  />
                );
              }
              return null;
            })}
          </Layer>
        </Stage>
      </div>
    </div>
  );
}
